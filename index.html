<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Our Memory DNA Tree</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Microsoft YaHei', sans-serif; }
        #canvas-container { width: 100%; height: 100%; position: absolute; z-index: 1; background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%); }
        
        /* UIå±‚ */
        #ui-layer { position: absolute; bottom: 30px; width: 100%; text-align: center; z-index: 10; pointer-events: none; }
        #wish-btn { 
            pointer-events: auto; background: linear-gradient(45deg, #ff0066, #ff5e00); 
            border: none; color: white; padding: 12px 30px; border-radius: 30px; 
            font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(255, 0, 102, 0.5);
            transition: transform 0.2s;
        }
        #wish-btn:active { transform: scale(0.95); }
        
        #top-msg { position: absolute; top: 20px; width: 100%; text-align: center; color: rgba(255,255,255,0.9); z-index: 10; font-size: 16px; letter-spacing: 2px; text-shadow: 0 0 10px #ff0066; }
        #music-control { position: absolute; top: 20px; right: 20px; z-index: 20; color: #ff0066; border: 1px solid #ff0066; padding: 5px 15px; border-radius: 15px; font-size: 12px; cursor: pointer; }
        
        /* Loading é®ç½© */
        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; color: #ff0066; flex-direction: column; transition: opacity 0.8s; }
        .loader-spinner { border: 4px solid rgba(255, 0, 102, 0.2); border-top: 4px solid #ff0066; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loader-spinner"></div>
        <div>æ­£åœ¨ä» 2025.9.12 æå–å›å¿†...</div>
        <div id="load-progress" style="font-size: 12px; color: #666; margin-top: 10px;">0%</div>
    </div>

    <div id="top-msg">âœ¨ Jiabao & Me âœ¨</div>
    <div id="music-control">ğŸµ Music Off</div>
    <div id="canvas-container"></div>
    
    <div id="ui-layer">
        <button id="wish-btn">ğŸ’– æˆ‘ä»¬çš„ç‚¹ç‚¹æ»´æ»´ ğŸ’–</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <script>
        // ================= é…ç½®åŒºåŸŸ (å…„å¼Ÿæ”¹è¿™é‡Œ) =================
        
        // 1. ä½ ä»¬çš„çºªå¿µæ—¥æ–‡å­—
        const baseText = "Since 2025.9.12"; 

        // 2. ä½ çš„èŠå¤©è®°å½•æ–‡ä»¶ååˆ—è¡¨ (æŒ‰æ—¶é—´é¡ºåºä»æ—§åˆ°æ–°æ’åˆ—)
        // ç¡®ä¿è¿™äº›æ–‡ä»¶å·²ç»ä¸Šä¼ åˆ°GitHubä»“åº“ï¼Œå’Œindex.htmlåœ¨åŒä¸€ä¸ªä½ç½®
        const chatImages = [
            // ç¤ºä¾‹æ•°æ®ï¼Œè¯·æ›¿æ¢æˆä½ è‡ªå·±çš„æ–‡ä»¶å
            // 'chat_01_begin.jpg',
            // 'chat_02_funny.jpg',
            // 'chat_03_love.jpg',
            // ... è¶Šå¤šè¶Šå£®è§‚ï¼Œå»ºè®® 20-40 å¼ 
            // ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œæˆ‘å…ˆç”¨ä¸€äº›å ä½å›¾ï¼Œä½ å‘å¸ƒå‰ä¸€å®šè¦åˆ æ‰ä¸‹é¢è¿™äº›
            'https://picsum.photos/id/10/300/300',
            'https://picsum.photos/id/20/300/400',
            'https://picsum.photos/id/30/300/300',
            'https://picsum.photos/id/40/300/400',
            'https://picsum.photos/id/50/300/300',
            'https://picsum.photos/id/60/300/400',
            'https://picsum.photos/id/70/300/300',
            'https://picsum.photos/id/80/300/400',
            'https://picsum.photos/id/90/300/300',
            'https://picsum.photos/id/100/300/400',
            'https://picsum.photos/id/110/300/300',
            'https://picsum.photos/id/120/300/400',
            'https://picsum.photos/id/130/300/300',
            'https://picsum.photos/id/140/300/400',
             'https://picsum.photos/id/150/300/300',
             'https://picsum.photos/id/160/300/300',
        ];

        // =======================================================

        let scene, camera, renderer, composer;
        let spiralGroup; // å­˜æ”¾æ‰€æœ‰ç…§ç‰‡çš„ç»„
        const photoMeshes = []; // å­˜æ”¾å•ä¸ªç…§ç‰‡ç½‘æ ¼æ–¹ä¾¿åŠ¨ç”»
        let baseMesh;
        let time = 0;

        init();

        function init() {
            scene = new THREE.Scene();
            // åˆ¶é€ ä¸€ç‚¹è¿·é›¾æ„Ÿ
            scene.fog = new THREE.FogExp2(0x1a1a2e, 0.002);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            // æ‘„åƒæœºä½ç½®ï¼šç¨å¾®ä»°è§†
            camera.position.set(0, 10, 55);
            camera.lookAt(0, 15, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // ä¼˜åŒ–æ€§èƒ½
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // åæœŸè¾‰å…‰ç‰¹æ•ˆ (è®©ç…§ç‰‡çœ‹èµ·æ¥åƒå…¨æ¯æŠ•å½±)
            const renderScene = new THREE.RenderPass(scene, camera);
            // å‚æ•°ï¼šå¼ºåº¦, åŠå¾„, é˜ˆå€¼ (å¼ºåº¦è°ƒé«˜ä¸€ç‚¹ï¼Œæ›´æœ‰ç§‘æŠ€æ„Ÿ)
            const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.8, 0.5, 0.8);
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            // ç¯å…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            // å¢åŠ ä¸€ä¸ªæš–è‰²ç‚¹å…‰æºåœ¨ä¸­å¿ƒ
            const pointLight = new THREE.PointLight(0xff0066, 1.5, 100);
            pointLight.position.set(0, 20, 0);
            scene.add(pointLight);

            // åˆ›å»ºæ ¸å¿ƒå†…å®¹
            createMemorySpiral();
            createBase();
            createParticles(); // å¢åŠ æ°›å›´ç²’å­

            window.addEventListener('resize', onWindowResize);
            
            // ç‚¹å‡»æŒ‰é’®äº§ç”Ÿç‰¹æ•ˆ
            document.getElementById('wish-btn').addEventListener('click', triggerBurst);
        }

        function createMemorySpiral() {
            spiralGroup = new THREE.Group();
            scene.add(spiralGroup);

            if (chatImages.length === 0) {
                 finishLoading(); return;
            }

            const loader = new THREE.TextureLoader();
            let loadedCount = 0;
            const progressDiv = document.getElementById('load-progress');

            const totalPhotos = chatImages.length;
            const heightStep = 1.2; // æ¯å¼ ç…§ç‰‡çš„é«˜åº¦é—´éš”
            const angleStep = 0.5;  // æ¯å¼ ç…§ç‰‡çš„è§’åº¦é—´éš” (å¼§åº¦)
            const maxRadius = 20;   // åº•éƒ¨çš„æœ€å¤§åŠå¾„

            chatImages.forEach((url, index) => {
                loader.load(url, (texture) => {
                    // æ ¹æ®å›¾ç‰‡æ¯”ä¾‹åˆ›å»ºå‡ ä½•ä½“
                    const aspect = texture.image.width / texture.image.height;
                    const baseSize = 6; // åŸºç¡€å¤§å°
                    const w = baseSize;
                    const h = baseSize / aspect;
                    const geometry = new THREE.PlaneGeometry(w, h);

                    // æ ¸å¿ƒæè´¨ï¼šå…¨æ¯å‘å…‰æ•ˆæœ
                    const material = new THREE.MeshBasicMaterial({
                        map: texture,
                        side: THREE.DoubleSide,
                        transparent: true,
                        opacity: 0.85, // åŠé€æ˜
                        blending: THREE.AdditiveBlending, // å åŠ å‘å…‰æ¨¡å¼
                        depthWrite: false // é˜²æ­¢é€æ˜é®æŒ¡é”™è¯¯
                    });

                    const mesh = new THREE.Mesh(geometry, material);

                    // --- èºæ—‹ä½ç½®è®¡ç®— (æ•°å­¦éƒ¨åˆ†) ---
                    const progress = index / totalPhotos; // 0 åˆ° 1 çš„è¿›åº¦
                    const y = index * heightStep + 2; // é«˜åº¦ä¸Šå‡
                    const angle = index * angleStep; // è§’åº¦æ—‹è½¬
                    const radius = maxRadius * (1 - progress * 0.8); // åŠå¾„éšé«˜åº¦å‡å°ï¼Œå½¢æˆé”¥å½¢

                    mesh.position.set(
                        Math.cos(angle) * radius,
                        y,
                        Math.sin(angle) * radius
                    );

                    // è®©ç…§ç‰‡ç¨å¾®é¢å‘å¤–ä¾§å€¾æ–œï¼Œæ›´æœ‰ç«‹ä½“æ„Ÿ
                    mesh.lookAt(new THREE.Vector3(mesh.position.x * 2, mesh.position.y, mesh.position.z * 2));
                    // ä¿å­˜åˆå§‹è§’åº¦ç”¨äºåŠ¨ç”»
                    mesh.userData.initialRotation = mesh.rotation.clone();
                    mesh.userData.angle = angle;
                    mesh.userData.radius = radius;

                    spiralGroup.add(mesh);
                    photoMeshes.push(mesh);

                    loadedCount++;
                    progressDiv.innerText = Math.floor((loadedCount / totalPhotos) * 100) + "%";
                    if (loadedCount === totalPhotos) finishLoading();

                }, undefined, (err) => {
                    console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', url);
                    loadedCount++;
                    if (loadedCount === totalPhotos) finishLoading();
                });
            });
        }

        function createBase() {
            // åˆ›å»ºä¸€ä¸ªå‘å…‰åœ†ç¯åº•åº§
            const geometry = new THREE.TorusGeometry(22, 0.5, 16, 100);
            const material = new THREE.MeshBasicMaterial({ color: 0xff0066 });
            const torus = new THREE.Mesh(geometry, material);
            torus.rotation.x = Math.PI / 2;
            torus.position.y = 0;
            scene.add(torus);

            // åˆ›å»ºåº•åº§æ–‡å­— (ç”¨Canvasç”»å‡ºæ¥è´´ä¸Šå»)
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ff0066';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('â¤ï¸ Jiabao & Me â¤ï¸', 256, 230);
            ctx.font = '30px Arial';
            ctx.fillText(baseText, 256, 280);
            
            const texture = new THREE.CanvasTexture(canvas);
            const planeGeo = new THREE.PlaneGeometry(15, 15);
            const planeMat = new THREE.MeshBasicMaterial({ map: texture, transparent: true, blending: THREE.AdditiveBlending, side: THREE.DoubleSide });
            baseMesh = new THREE.Mesh(planeGeo, planeMat);
            baseMesh.rotation.x = -Math.PI / 2; // å¹³èºº
            baseMesh.position.y = 0.5;
            scene.add(baseMesh);
        }

        function createParticles() {
            // å¢åŠ ç¯å¢ƒä¸­çš„æ¼‚æµ®å…‰ç‚¹
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 500; i++) {
                vertices.push(THREE.MathUtils.randFloatSpread(100)); // x
                vertices.push(THREE.MathUtils.randFloatSpread(100) + 20); // y (åä¸Šæ–¹)
                vertices.push(THREE.MathUtils.randFloatSpread(100)); // z
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const material = new THREE.PointsMaterial({ color: 0xff0066, size: 0.4, transparent: true, opacity: 0.5, blending: THREE.AdditiveBlending });
            const points = new THREE.Points(geometry, material);
            scene.add(points);
        }

        function finishLoading() {
             document.getElementById('loading').style.opacity = 0;
             setTimeout(() => document.getElementById('loading').remove(), 800);
             animate();
        }

        function triggerBurst() {
            // ç‚¹å‡»æŒ‰é’®æ—¶çš„ç‰¹æ•ˆï¼šæ‰€æœ‰ç…§ç‰‡ç¬é—´è†¨èƒ€å†æ”¶ç¼©
            photoMeshes.forEach(mesh => {
                const originalScale = mesh.scale.x;
                // ç®€å•çš„å¼¹è·³åŠ¨ç”»
                new TWEEN.Tween(mesh.scale)
                    .to({ x: originalScale * 1.5, y: originalScale * 1.5 }, 200)
                    .easing(TWEEN.Easing.Quadratic.Out)
                    .chain(
                        new TWEEN.Tween(mesh.scale)
                            .to({ x: originalScale, y: originalScale }, 500)
                            .easing(TWEEN.Easing.Elastic.Out)
                    )
                    .start();
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.005;
            TWEEN.update();

            // 1. æ•´ä½“èºæ—‹ä¸Šå‡æ—‹è½¬ (æ ¸å¿ƒåŠ¨ç”»)
            if (spiralGroup) {
                spiralGroup.rotation.y -= 0.002; // ç¼“æ…¢è‡ªè½¬
            }

            // 2. å•ä¸ªç…§ç‰‡çš„åŠ¨æ€æ•ˆæœ
            photoMeshes.forEach((mesh, i) => {
                // è®©ç…§ç‰‡åœ¨åŸåœ°è½»å¾®ä¸Šä¸‹æµ®åŠ¨ï¼Œå¢åŠ çµåŠ¨æ„Ÿ
                mesh.position.y += Math.sin(time * 2 + i) * 0.02;
                
                // è®©ç…§ç‰‡è½»å¾®è‡ªè½¬ï¼Œå±•ç¤ºå…¨æ¯æ„Ÿ
                mesh.rotation.y = mesh.userData.initialRotation.y + Math.sin(time + i * 0.5) * 0.1;
            });
            
            // 3. åº•åº§æ–‡å­—ç¼“æ…¢æ—‹è½¬
            if(baseMesh) {
                baseMesh.rotation.z += 0.005;
            }
            
            // 4. æ‘„åƒæœºç¼“æ…¢ç¯ç»•è¿åŠ¨
            camera.position.x = Math.cos(time * 0.2) * 55;
            camera.position.z = Math.sin(time * 0.2) * 55;
            camera.lookAt(0, 20, 0); // å§‹ç»ˆçœ‹ç€æ ‘ä¸­å¿ƒåä¸Šçš„ä½ç½®

            composer.render();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        // éŸ³ä¹æ§åˆ¶ (éœ€è¦æ›¿æ¢ä½ è‡ªå·±çš„mp3é“¾æ¥)
        let musicPlaying = false;
        // å»ºè®®æ‰¾ä¸€é¦–å¯¹ä½ ä»¬æœ‰æ„ä¹‰çš„æ­Œï¼Œä¸Šä¼ åˆ°ç½‘ç›˜è·å–ç›´é“¾
        const audio = new Audio('https://cdn.pixabay.com/download/audio/2022/10/28/audio_b0984c5738.mp3?filename=christmas-dream-124578.mp3'); 
        audio.loop = true; audio.volume = 0.6;
        document.getElementById('music-control').addEventListener('click', function() {
            if (!musicPlaying) {
                audio.play().then(() => {
                    this.innerText = "ğŸµ Playing...";
                    this.style.color = "#ff0066";
                    musicPlaying = true;
                }).catch(e => console.log("éœ€ç”¨æˆ·äº¤äº’æ’­æ”¾"));
            } else {
                audio.pause();
                this.innerText = "ğŸµ Music Off";
                this.style.color = "rgba(255,255,255,0.9)";
                musicPlaying = false;
            }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</body>
</html>
