<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Our Memory DNA Tree</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Microsoft YaHei', sans-serif; }
        #canvas-container { width: 100%; height: 100%; position: absolute; z-index: 1; background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%); }
        
        /* UIÂ±Ç */
        #ui-layer { position: absolute; bottom: 30px; width: 100%; text-align: center; z-index: 10; pointer-events: none; }
        #wish-btn { 
            pointer-events: auto; background: linear-gradient(45deg, #ff0066, #ff5e00); 
            border: none; color: white; padding: 12px 30px; border-radius: 30px; 
            font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(255, 0, 102, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #wish-btn:active { transform: scale(0.95); box-shadow: 0 0 10px rgba(255, 0, 102, 0.8); }
        
        #top-msg { position: absolute; top: 20px; width: 100%; text-align: center; color: rgba(255,255,255,0.9); z-index: 10; font-size: 16px; letter-spacing: 2px; text-shadow: 0 0 10px #ff0066; }
        #music-control { position: absolute; top: 20px; right: 20px; z-index: 20; color: #ff0066; border: 1px solid #ff0066; padding: 5px 15px; border-radius: 15px; font-size: 12px; cursor: pointer; }
        
        /* Loading ÈÅÆÁΩ© */
        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; color: #ff0066; flex-direction: column; transition: opacity 0.8s; }
        .loader-spinner { border: 4px solid rgba(255, 0, 102, 0.2); border-top: 4px solid #ff0066; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loader-spinner"></div>
        <div>Ê≠£Âú®ÊèêÂèñ 2025.9.12 ‰ª•Êù•ÁöÑÂõûÂøÜ...</div>
        <div id="load-progress" style="font-size: 12px; color: #666; margin-top: 10px;">0%</div>
    </div>

    <div id="top-msg">‚ú® Jiabao & Me ‚ú®</div>
    <div id="music-control">üéµ Music Off</div>
    <div id="canvas-container"></div>
    
    <div id="ui-layer">
        <button id="wish-btn">‚ú® ÁÇπ‰∫ÆÊàë‰ª¨ÁöÑ‰∏ìÂ±ûÊó∂Âàª ‚ú®</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <script>
        // ================= ÈÖçÁΩÆÂå∫Âüü =================
        const baseText = "Since 2025.9.12"; 

        // „ÄêÈáçË¶ÅÊèêÁ§∫„Äë
        // 1. ÊôÆÈÄöËÅäÂ§©ËÆ∞ÂΩïÊ≠£Â∏∏ÂëΩÂêçÔºåÂ¶Ç 'chat01.jpg'
        // 2. ‰Ω†ÊÉ≥ÁâπÊÆä‰∫íÂä®ÁöÑÂêàÁÖßÔºåÊñá‰ª∂ÂêçËØ∑‰ª• 'love_' ÂºÄÂ§¥ÔºåÂ¶Ç 'love_ÂêàÁÖß1.jpg'
        const chatImages = [
            'chat01.jpg',
            'chat02.jpg',
            'chat04.jpg',
            'chat05.jpg',
            'chat07.jpg',
            'chat08.jpg',
            'chat09.jpg',
            'chat10.jpg',
            'chat11.jpg',
            'chat12.jpg',
            'chat13.jpg',
            'chat14.jpg',
            'chat15.jpg',
            'chat16.jpg',
            'chat17.jpg',
            'chat18.jpg',
            'chat19.jpg',
            'love_1.jpg',
            'love_2.jpg',
            'chat20.jpg'
        ];
        // =======================================================

        let scene, camera, renderer, composer, bloomPass;
        let spiralGroup; 
        const photoMeshes = []; 
        let baseMesh;
        let time = 0;
        let isInteracting = false; // Èò≤Ê≠¢ËøûÁª≠ÁÇπÂáª

        init();

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x1a1a2e, 0.0015); // ÈõæÊ∞îÁ®çÂæÆÊ∑°‰∏ÄÁÇπÔºåÁúãÊ∏ÖÁÖßÁâá

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            // Ë∞ÉÊï¥ÊëÑÂÉèÊú∫‰ΩçÁΩÆÔºåÁ¶ªÂæóÁ®çÂæÆËøú‰∏ÄÁÇπÔºåÂõ†‰∏∫ÁÖßÁâáÂèòÂ§ß‰∫Ü
            camera.position.set(0, 12, 65);
            camera.lookAt(0, 20, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            const renderScene = new THREE.RenderPass(scene, camera);
            // Ë∞ÉÊï¥ËæâÂÖâÂèÇÊï∞ÔºåËÆ©Â§ßÁÖßÁâáÁúãËµ∑Êù•‰∏çÈÇ£‰πàÂà∫Áúº
            bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xff0066, 1.2, 100);
            pointLight.position.set(0, 25, 0);
            scene.add(pointLight);

            createMemorySpiral();
            createBase();
            createParticles(); 

            window.addEventListener('resize', onWindowResize);
            document.getElementById('wish-btn').addEventListener('click', triggerSpecialMoment);
        }

        function createMemorySpiral() {
            spiralGroup = new THREE.Group();
            scene.add(spiralGroup);

            if (chatImages.length === 0) { finishLoading(); return; }

            const loader = new THREE.TextureLoader();
            let loadedCount = 0;
            const progressDiv = document.getElementById('load-progress');

            const totalPhotos = chatImages.length;
            // „ÄêÂÖ≥ÈîÆ‰øÆÊîπ„ÄëÂ¢ûÂä†ÁÖßÁâáÂü∫Á°ÄÂ∞∫ÂØ∏ÂíåÈó¥Ë∑ù
            const baseSize = 14; // ÂéüÊù•ÊòØ 6ÔºåÁé∞Âú®ÊîπÂ§ßÂà∞ 14
            const heightStep = 2.0; // Â¢ûÂä†ÂûÇÁõ¥Èó¥Ë∑ù
            const angleStep = 0.45;  
            const maxRadius = 25;   // Á®çÂæÆÂ¢ûÂä†Â∫ïÈÉ®ÂçäÂæÑ

            chatImages.forEach((url, index) => {
                loader.load(url, (texture) => {
                    const aspect = texture.image.width / texture.image.height;
                    const w = baseSize;
                    const h = baseSize / aspect;
                    const geometry = new THREE.PlaneGeometry(w, h);

                    // „ÄêÂÖ≥ÈîÆ‰øÆÊîπ„ÄëËØÜÂà´ÁâπÊÆäÁÖßÁâá
                    const isSpecial = url.includes('love_');

                    const material = new THREE.MeshBasicMaterial({
                        map: texture,
                        side: THREE.DoubleSide,
                        transparent: true,
                        // ÁâπÊÆäÁÖßÁâáÊõ¥‰∏çÈÄèÊòé(Êõ¥‰∫Æ)ÔºåÊôÆÈÄöÁÖßÁâáÂçäÈÄèÊòé
                        opacity: isSpecial ? 1.0 : 0.8, 
                        blending: THREE.AdditiveBlending,
                        depthWrite: false
                    });

                    const mesh = new THREE.Mesh(geometry, material);

                    const progress = index / totalPhotos; 
                    const y = index * heightStep + 5; 
                    const angle = index * angleStep; 
                    const radius = maxRadius * (1 - progress * 0.7); 

                    mesh.position.set(Math.cos(angle) * radius, y, Math.sin(angle) * radius);
                    mesh.lookAt(new THREE.Vector3(mesh.position.x * 2, mesh.position.y, mesh.position.z * 2));
                    
                    mesh.userData = {
                        initialRotation: mesh.rotation.clone(),
                        angle: angle,
                        radius: radius,
                        // Ê†áËÆ∞ÊòØÂê¶‰∏∫ÁâπÊÆäÁÖßÁâá
                        isSpecial: isSpecial
                    };

                    spiralGroup.add(mesh);
                    photoMeshes.push(mesh);

                    loadedCount++;
                    progressDiv.innerText = Math.floor((loadedCount / totalPhotos) * 100) + "%";
                    if (loadedCount === totalPhotos) finishLoading();

                }, undefined, (err) => console.error('Âä†ËΩΩÂ§±Ë¥•:', url));
            });
        }

        function createBase() {
            const geometry = new THREE.TorusGeometry(28, 0.5, 16, 100);
            const material = new THREE.MeshBasicMaterial({ color: 0xff0066 });
            const torus = new THREE.Mesh(geometry, material);
            torus.rotation.x = Math.PI / 2; scene.add(torus);

            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ff0066';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('‚ù§Ô∏è Jiabao & Me ‚ù§Ô∏è', 256, 230);
            ctx.font = '30px Arial';
            ctx.fillText(baseText, 256, 280);
            
            const texture = new THREE.CanvasTexture(canvas);
            const planeGeo = new THREE.PlaneGeometry(20, 20);
            const planeMat = new THREE.MeshBasicMaterial({ map: texture, transparent: true, blending: THREE.AdditiveBlending, side: THREE.DoubleSide });
            baseMesh = new THREE.Mesh(planeGeo, planeMat);
            baseMesh.rotation.x = -Math.PI / 2; baseMesh.position.y = 0.5;
            scene.add(baseMesh);
        }

        function createParticles() {
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 600; i++) {
                vertices.push(THREE.MathUtils.randFloatSpread(120)); 
                vertices.push(THREE.MathUtils.randFloatSpread(120) + 30); 
                vertices.push(THREE.MathUtils.randFloatSpread(120)); 
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const material = new THREE.PointsMaterial({ color: 0xff0066, size: 0.5, transparent: true, opacity: 0.5, blending: THREE.AdditiveBlending });
            const points = new THREE.Points(geometry, material);
            scene.add(points);
        }

        function finishLoading() {
             document.getElementById('loading').style.opacity = 0;
             setTimeout(() => document.getElementById('loading').remove(), 800);
             animate();
        }

        // „ÄêÂÖ≥ÈîÆ‰øÆÊîπ„ÄëÂÖ®Êñ∞ÁöÑ‰∫íÂä®ÈÄªËæë
        function triggerSpecialMoment() {
            if(isInteracting) return;
            isInteracting = true;

            // 1. ËæâÂÖâÁû¨Èó¥Â¢ûÂº∫
            new TWEEN.Tween(bloomPass)
                .to({ strength: 3.5, radius: 1.0 }, 300)
                .easing(TWEEN.Easing.Quadratic.Out)
                .chain(
                    new TWEEN.Tween(bloomPass)
                        .to({ strength: 1.5, radius: 0.4 }, 1500)
                        .easing(TWEEN.Easing.Quadratic.In)
                )
                .start();

            photoMeshes.forEach(mesh => {
                const originalScale = mesh.scale.x;
                
                if (mesh.userData.isSpecial) {
                    // === ÁâπÊÆäÂêàÁÖßÔºöÁºìÊÖ¢360Â∫¶ÊóãËΩ¨Ëá¥Êï¨ ===
                    new TWEEN.Tween(mesh.rotation)
                        // Âú®ÂΩìÂâçÂü∫Á°Ä‰∏äÂ¢ûÂä† 2*PI (360Â∫¶) Âπ∂Á®çÂæÆÊä¨Ëµ∑Â§¥
                        .to({ y: mesh.rotation.y + Math.PI * 2, x: mesh.rotation.x - 0.3 }, 2500) 
                        .easing(TWEEN.Easing.Cubic.InOut)
                        .onComplete(() => {
                            // Âä®ÁîªÁªìÊùüÂêéÊÅ¢Â§çÂéüÁä∂
                             new TWEEN.Tween(mesh.rotation)
                                .to({ x: mesh.userData.initialRotation.x }, 1000)
                                .easing(TWEEN.Easing.Quadratic.Out)
                                .start();
                        })
                        .start();
                        
                     // ÂêåÊó∂ËΩªÂæÆÊîæÂ§ß
                     new TWEEN.Tween(mesh.scale)
                        .to({ x: originalScale * 1.2, y: originalScale * 1.2 }, 1250)
                        .easing(TWEEN.Easing.Sinusoidal.Out)
                        .yoyo(true).repeat(1)
                        .start();

                } else {
                    // === ÊôÆÈÄöÁÖßÁâáÔºöÂø´ÈÄüÂºπË∑≥ ===
                    new TWEEN.Tween(mesh.scale)
                        .to({ x: originalScale * 1.3, y: originalScale * 1.3 }, 200)
                        .easing(TWEEN.Easing.Quadratic.Out)
                        .chain(
                            new TWEEN.Tween(mesh.scale)
                                .to({ x: originalScale, y: originalScale }, 500)
                                .easing(TWEEN.Easing.Elastic.Out)
                        )
                        .start();
                }
            });

            // 3ÁßíÂêéÂÖÅËÆ∏ÂÜçÊ¨°ÁÇπÂáª
            setTimeout(() => { isInteracting = false; }, 3000);
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.005;
            TWEEN.update();

            if (spiralGroup) spiralGroup.rotation.y -= 0.0015; 

            photoMeshes.forEach((mesh, i) => {
                // Âè™Êúâ‰∏çÂú®‰∫§‰∫íÁä∂ÊÄÅÊó∂ÊâçËøõË°åÊó•Â∏∏ÊµÆÂä®ÔºåÈÅøÂÖçÂÜ≤Á™Å
                if(!isInteracting) {
                     mesh.position.y += Math.sin(time * 2 + i) * 0.015;
                     // ÁâπÊÆäÁÖßÁâáËá™ËΩ¨Á®çÂæÆÂø´‰∏ÄÁÇπÁÇπ
                     const rotateSpeed = mesh.userData.isSpecial ? 0.15 : 0.08;
                     mesh.rotation.y = mesh.userData.initialRotation.y + Math.sin(time + i * 0.5) * rotateSpeed;
                }
            });
            
            if(baseMesh) baseMesh.rotation.z += 0.004;
            
            camera.position.x = Math.cos(time * 0.15) * 65;
            camera.position.z = Math.sin(time * 0.15) * 65;
            camera.lookAt(0, 25, 0); 

            composer.render();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        let musicPlaying = false;
        // Âª∫ËÆÆÊõøÊç¢Êàê‰Ω†‰ª¨ÂñúÊ¨¢ÁöÑÊ≠åÁöÑÁõ¥Èìæ
        const audio = new Audio('https://cdn.pixabay.com/download/audio/2022/10/28/audio_b0984c5738.mp3?filename=christmas-dream-124578.mp3'); 
        audio.loop = true; audio.volume = 0.6;
        document.getElementById('music-control').addEventListener('click', function() {
            if (!musicPlaying) {
                audio.play().then(() => {
                    this.innerText = "üéµ Playing...";
                    this.style.color = "#ff0066";
                    musicPlaying = true;
                }).catch(e => console.log("ÈúÄÁî®Êà∑‰∫§‰∫íÊí≠Êîæ"));
            } else {
                audio.pause();
                this.innerText = "üéµ Music Off";
                this.style.color = "rgba(255,255,255,0.9)";
                musicPlaying = false;
            }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</body>
</html>
