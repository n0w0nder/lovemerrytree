<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>For You: A Cyber Christmas</title>
    <style>
        /* èµ›åšæœ‹å…‹é£æ ¼ç•Œé¢å®šä¹‰ */
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Arial', sans-serif; }
        #canvas-container { width: 100%; height: 100%; position: absolute; z-index: 1; }
        
        /* UI å±‚ */
        #ui-layer {
            position: absolute; bottom: 20px; width: 100%; text-align: center; z-index: 10;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°è¾“å…¥æ¡† */
        }
        #input-box {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #00f7ff;
            color: #00f7ff;
            padding: 10px;
            border-radius: 20px;
            outline: none;
            width: 60%;
            font-size: 16px;
            box-shadow: 0 0 10px #00f7ff;
            transition: all 0.3s;
        }
        #input-box:focus { box-shadow: 0 0 20px #00f7ff, inset 0 0 10px #00f7ff; }
        #send-btn {
            pointer-events: auto;
            background: linear-gradient(45deg, #00f7ff, #d400ff);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            margin-left: 10px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 0 10px #d400ff;
        }
        #send-btn:active { transform: scale(0.95); }

        /* é¡¶éƒ¨æç¤º */
        #top-msg {
            position: absolute; top: 20px; width: 100%; text-align: center; color: rgba(255,255,255,0.7);
            z-index: 10; font-size: 14px; text-shadow: 0 0 5px #00f7ff;
        }
        /* éŸ³ä¹æŒ‰é’® */
        #music-control {
            position: absolute; top: 20px; right: 20px; z-index: 20; color: #00f7ff;
            border: 1px solid #00f7ff; padding: 5px 10px; border-radius: 15px; font-size: 12px; cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="top-msg">âœ¨ è¾“å…¥ä½ çš„æ„¿æœ›ï¼Œç‚¹äº®è¿™æ£µæ ‘ âœ¨</div>
    <div id="music-control">ğŸµ Play Music</div>
    <div id="canvas-container"></div>
    
    <div id="ui-layer">
        <input type="text" id="input-box" placeholder="è®¸ä¸ªæ„¿å§..." maxlength="20">
        <button id="send-btn">å‘é€æ„¿æœ›</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>


    <script>
        let scene, camera, renderer, composer;
        let treeParticles, starPoints;
        const wishes = []; // å­˜æ”¾è®¸æ„¿çƒ

        init();
        animate();

        function init() {
            // 1. åœºæ™¯æ­å»º
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.001);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 50;
            camera.position.y = 10;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // 2. è¾‰å…‰ç‰¹æ•ˆåæœŸå¤„ç† (è®©æ ‘å‘å…‰çš„å…³é”®)
            const renderScene = new THREE.RenderPass(scene, camera);
            // BloomPass å‚æ•°ï¼šå¼ºåº¦, åŠå¾„, é˜ˆå€¼
            const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            // 3. åˆ›å»ºç²’å­åœ£è¯æ ‘
            createParticleTree();
            // 4. åˆ›å»ºèƒŒæ™¯æ˜Ÿç©º
            createStars();
            // 5. åˆ›å»ºé¡¶éƒ¨å¤§æ˜Ÿæ˜Ÿ
            createTopStar();

            // ç¯å…‰
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0x00f7ff, 1, 100);
            pointLight.position.set(0, 20, 20);
            scene.add(pointLight);

            // ç›‘å¬çª—å£ç¼©æ”¾
            window.addEventListener('resize', onWindowResize);

            // UI äº¤äº’ç›‘å¬
            document.getElementById('send-btn').addEventListener('click', makeWish);
            // ä¹Ÿå¯ä»¥æŒ‰å›è½¦å‘é€
            document.getElementById('input-box').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') makeWish();
            });
        }

        // --- æ ¸å¿ƒç»„ä»¶åˆ›å»ºå‡½æ•° ---

        function createParticleTree() {
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            const colors = [];
            
            const layers = 80; // å±‚æ•°
            const countPerLayer = 30; // æ¯å±‚ç²’å­æ•°
            let heightStep = 0.5;
            let maxWidth = 18;

            for (let i = 0; i < layers; i++) {
                let y = i * heightStep;
                let currentRadius = maxWidth * (1 - i / layers); // è¶Šå¾€ä¸Šè¶Šçª„
                
                for (let j = 0; j < countPerLayer; j++) {
                    let angle = (j / countPerLayer) * Math.PI * 2 + i * 0.1; // èºæ—‹åç§»
                    // åŠ å…¥ä¸€äº›éšæœºæ‰°åŠ¨ï¼Œè®©æ ‘çœ‹èµ·æ¥æ›´è‡ªç„¶
                    let r = currentRadius + (Math.random() - 0.5) * 1.5;
                    let x = r * Math.cos(angle);
                    let z = r * Math.sin(angle);
                    
                    vertices.push(x, y - 20, z); // æŠŠæ ‘å¾€ä¸‹æ”¾ä¸€ç‚¹
                    
                    // é¢œè‰²æ¸å˜ï¼šåº•éƒ¨å†·è‰²è°ƒï¼Œé¡¶éƒ¨æš–è‰²è°ƒ
                    const color = new THREE.Color();
                    color.setHSL(0.6 - i/layers * 0.5, 1.0, 0.6);
                    colors.push(color.r, color.g, color.b);
                }
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            // ä½¿ç”¨ç‚¹æè´¨ï¼Œå¹¶å¼€å¯é¡¶ç‚¹é¢œè‰²
            const material = new THREE.PointsMaterial({
                size: 0.6,
                vertexColors: true,
                blending: THREE.AdditiveBlending, // å‘å…‰å åŠ æ¨¡å¼
                transparent: true,
                opacity: 0.9,
                map: getTexture() // è·å–åœ†å½¢çº¹ç†
            });

            treeParticles = new THREE.Points(geometry, material);
            scene.add(treeParticles);
        }

        function createStars() {
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 1000; i++) {
                vertices.push(THREE.MathUtils.randFloatSpread(200)); // x
                vertices.push(THREE.MathUtils.randFloatSpread(200)); // y
                vertices.push(THREE.MathUtils.randFloatSpread(200)); // z
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const material = new THREE.PointsMaterial({ color: 0x888888, size: 0.3 });
            starPoints = new THREE.Points(geometry, material);
            scene.add(starPoints);
        }

        function createTopStar() {
            // ç®€å•çš„é¡¶éƒ¨å¤§å…‰ç‚¹
            const geometry = new THREE.SphereGeometry(1, 16, 16);
            const material = new THREE.MeshBasicMaterial({ color: 0xffdd00 });
            const topStar = new THREE.Mesh(geometry, material);
            topStar.position.set(0, 22, 0);
            // ç»™å®ƒåŠ ä¸€ä¸ªå¼ºå…‰ç‚¹
            const light = new THREE.PointLight(0xffdd00, 2, 50);
            topStar.add(light);
            scene.add(topStar);
        }

        // --- äº¤äº’é€»è¾‘ (ä¼ªAIéƒ¨åˆ†) ---

        function makeWish() {
            const input = document.getElementById('input-box');
            const text = input.value.trim();
            if (text === "") return;

            input.value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('top-msg').innerText = `æ­£åœ¨ä¸º "${text}" æ³¨å…¥èƒ½é‡...`;

            // 1. åˆ†ææ–‡æœ¬æƒ…ç»ª (ç®€å•çš„å…³é”®è¯åŒ¹é…æ¥æ”¹å˜é¢œè‰²)
            let wishColor = 0x00f7ff; // é»˜è®¤èµ›åšè“
            const warmKeywords = ['çˆ±', 'å–œæ¬¢', 'love', 'æš–', 'ä½ ', 'åœ¨ä¸€èµ·'];
            const richKeywords = ['é’±', 'å¯Œ', 'å‘è´¢', 'money'];
            if (warmKeywords.some(k => text.includes(k))) wishColor = 0xff0066; // ç²‰è‰²
            else if (richKeywords.some(k => text.includes(k))) wishColor = 0xffd700; // é‡‘è‰²

            // 2. åˆ›å»ºæ–‡å­—çº¹ç†
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 256; canvas.height = 128;
            ctx.fillStyle = '#'+wishColor.toString(16);
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(text, 128, 64);
            const texture = new THREE.CanvasTexture(canvas);

            // 3. åˆ›å»ºè®¸æ„¿çƒ Sprite (æ°¸è¿œé¢å‘ç›¸æœºçš„å¹³é¢)
            const material = new THREE.SpriteMaterial({ map: texture, color: 0xffffff });
            const sprite = new THREE.Sprite(material);
            sprite.scale.set(8, 4, 1);
            
            // åˆå§‹ä½ç½®åœ¨å±å¹•å¤–ä¸‹æ–¹
            sprite.position.set((Math.random()-0.5)*10, -30, 10 + Math.random()*10);
            
            // ç›®æ ‡ä½ç½®ï¼šæ ‘ä¸Šçš„éšæœºä¸€ç‚¹
            const targetY = Math.random() * 30 - 10;
            const targetRadius = (20 - (targetY+20)/2) * 0.8;
            const angle = Math.random() * Math.PI * 2;
            sprite.userData = {
                targetPos: new THREE.Vector3(targetRadius * Math.cos(angle), targetY, targetRadius * Math.sin(angle)),
                speed: 0.02 + Math.random()*0.01
            };
            
            scene.add(sprite);
            wishes.push(sprite); // åŠ å…¥åŠ¨ç”»é˜Ÿåˆ—

            setTimeout(()=>{
                 document.getElementById('top-msg').innerText = `âœ¨ æ„¿æœ›å·²æŒ‚è½½ï¼Œèƒ½é‡ä¼ è¾“å®Œæ¯• âœ¨`;
            }, 2000);
        }


        // --- åŠ¨ç”»å¾ªç¯ ---
        function animate() {
            requestAnimationFrame(animate);

            // æ ‘å’ŒèƒŒæ™¯çš„ç¼“æ…¢æ—‹è½¬
            treeParticles.rotation.y += 0.002;
            starPoints.rotation.y -= 0.0005;

            // æ‘„åƒæœºè½»å¾®æµ®åŠ¨
            camera.position.y = 10 + Math.sin(Date.now() * 0.001) * 2;

            // æ›´æ–°æ‰€æœ‰è®¸æ„¿çƒçš„ä½ç½®
            wishes.forEach(sprite => {
                // å‘ç›®æ ‡ä½ç½®ç§»åŠ¨ (ç®€å•çš„çº¿æ€§æ’å€¼)
                sprite.position.lerp(sprite.userData.targetPos, sprite.userData.speed);
                // è®©å®ƒä¸€ç›´æ…¢æ…¢è½¬åŠ¨ä¸€ç‚¹ï¼Œå¢åŠ åŠ¨æ„Ÿ
                sprite.material.rotation += 0.01;
            });

            // ä½¿ç”¨ç»„åˆå™¨æ¸²æŸ“ï¼ˆåŒ…å«è¾‰å…‰ç‰¹æ•ˆï¼‰
            composer.render();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºä¸€ä¸ªåœ†å½¢çš„çº¹ç†ï¼Œè®©ç²’å­çœ‹èµ·æ¥æ˜¯åœ†ç‚¹è€Œä¸æ˜¯æ–¹å—
        function getTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
            gradient.addColorStop(0, 'rgba(255,255,255,1)');
            gradient.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 32, 32);
            const texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;
            return texture;
        }

        // ç®€å•çš„éŸ³ä¹æ§åˆ¶
        let musicPlaying = false;
        // è¿™æ˜¯ä¸€ä¸ªå…è´¹çš„åœ£è¯éŸ³ä¹å¤–é“¾ï¼Œå¦‚æœå¤±æ•ˆä½ éœ€è¦æ›¿æ¢æˆè‡ªå·±çš„ mp3 é“¾æ¥
        const audio = new Audio('https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3?filename=christmas-ident-126633.mp3'); 
        audio.loop = true;
        audio.volume = 0.5;
        document.getElementById('music-control').addEventListener('click', function() {
            if (!musicPlaying) {
                audio.play().then(() => {
                    this.innerText = "ğŸµ Playing...";
                    this.style.borderColor = "#d400ff";
                    this.style.color = "#d400ff";
                    musicPlaying = true;
                }).catch(e => { console.log("éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾éŸ³ä¹"); });
            } else {
                audio.pause();
                this.innerText = "ğŸµ Play Music";
                this.style.borderColor = "#00f7ff";
                this.style.color = "#00f7ff";
                musicPlaying = false;
            }
        });
    </script>
</body>
</html>
