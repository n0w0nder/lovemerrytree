<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Our Memory Tree</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Arial', sans-serif; }
        #canvas-container { width: 100%; height: 100%; position: absolute; z-index: 1; }
        
        #ui-layer { position: absolute; bottom: 20px; width: 100%; text-align: center; z-index: 10; pointer-events: none; }
        #input-box { pointer-events: auto; background: rgba(0, 0, 0, 0.6); border: 1px solid #00f7ff; color: #00f7ff; padding: 10px; border-radius: 20px; outline: none; width: 60%; font-size: 16px; box-shadow: 0 0 10px #00f7ff; }
        #send-btn { pointer-events: auto; background: linear-gradient(45deg, #00f7ff, #d400ff); border: none; color: white; padding: 10px 20px; border-radius: 20px; margin-left: 10px; font-size: 16px; cursor: pointer; }
        
        #top-msg { position: absolute; top: 20px; width: 100%; text-align: center; color: rgba(255,255,255,0.8); z-index: 10; font-size: 14px; text-shadow: 0 0 5px #00f7ff; }
        #music-control { position: absolute; top: 20px; right: 20px; z-index: 20; color: #00f7ff; border: 1px solid #00f7ff; padding: 5px 10px; border-radius: 15px; font-size: 12px; cursor: pointer; }
        
        /* Loading é®ç½© */
        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; color: #00f7ff; flex-direction: column; transition: opacity 1s; }
    </style>
</head>
<body>
    <div id="loading">
        <div>æ­£åœ¨æ„å»ºæµªæ¼«å®‡å®™...</div>
        <div style="font-size: 12px; color: #666; margin-top: 10px;">èµ„æºåŠ è½½ä¸­</div>
    </div>

    <div id="top-msg">âœ¨ æ¯ä¸€é¢—ç²’å­ï¼Œéƒ½æ˜¯æˆ‘æƒ³ä½ çš„ç¬é—´ âœ¨</div>
    <div id="music-control">ğŸµ Music Off</div>
    <div id="canvas-container"></div>
    
    <div id="ui-layer">
        <input type="text" id="input-box" placeholder="å†™ä¸‹æ˜å¹´çš„æ„¿æœ›..." maxlength="20">
        <button id="send-btn">å‘é€</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        // è¿™é‡Œå¡«ä½ ä¸Šä¼ åˆ°GitHubçš„ç…§ç‰‡æ–‡ä»¶å
        // å¦‚æœæ²¡æœ‰ç…§ç‰‡ï¼Œä¿ç•™ç©ºæ•°ç»„ []ï¼Œç¨‹åºä¼šè‡ªåŠ¨å¿½ç•¥
        const myPhotos = [
            'p1.jpg', 
            'p2.jpg',
            'p3.jpg' 
        ]; 
        // ===========================================

        let scene, camera, renderer, composer, bloomPass;
        let treeParticles, starPoints;
        const wishes = []; 
        const photoOrbits = [];
        let time = 0;

        init();
        animate();

        function init() {
            // åœºæ™¯
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.001);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 45;
            camera.position.y = 10;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // åæœŸè¾‰å…‰
            const renderScene = new THREE.RenderPass(scene, camera);
            bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.6, 0.4, 0.85);
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            createParticleTree();
            createStars();
            createTopStar();
            
            // åŠ è½½ç…§ç‰‡
            if(myPhotos.length > 0) {
                loadPhotos();
            } else {
                document.getElementById('loading').style.opacity = 0;
                setTimeout(()=> document.getElementById('loading').remove(), 1000);
            }

            // ç¯å…‰
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);

            window.addEventListener('resize', onWindowResize);
            document.getElementById('send-btn').addEventListener('click', makeWish);
        }

        function createParticleTree() {
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            const colors = [];
            const layers = 90; 
            const countPerLayer = 35; 
            let maxWidth = 18;

            for (let i = 0; i < layers; i++) {
                let y = i * 0.5;
                let currentRadius = maxWidth * (1 - i / layers);
                for (let j = 0; j < countPerLayer; j++) {
                    let angle = (j / countPerLayer) * Math.PI * 2 + i * 0.15;
                    let r = currentRadius + (Math.random() - 0.5) * 1.0;
                    let x = r * Math.cos(angle);
                    let z = r * Math.sin(angle);
                    vertices.push(x, y - 22, z);
                    
                    const color = new THREE.Color();
                    // æ›´åŠ æ¢¦å¹»çš„è“ç´«é…è‰²
                    color.setHSL(0.55 + Math.random()*0.1, 0.9, 0.6);
                    colors.push(color.r, color.g, color.b);
                }
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            const material = new THREE.PointsMaterial({ size: 0.5, vertexColors: true, blending: THREE.AdditiveBlending, transparent: true, opacity: 0.9, map: getTexture() });
            treeParticles = new THREE.Points(geometry, material);
            scene.add(treeParticles);
        }

        function createStars() {
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 1500; i++) {
                vertices.push(THREE.MathUtils.randFloatSpread(300));
                vertices.push(THREE.MathUtils.randFloatSpread(300));
                vertices.push(THREE.MathUtils.randFloatSpread(300));
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const material = new THREE.PointsMaterial({ color: 0x888888, size: 0.4, transparent: true, opacity: 0.6 });
            starPoints = new THREE.Points(geometry, material);
            scene.add(starPoints);
        }

        function createTopStar() {
            const geometry = new THREE.SphereGeometry(1.2, 16, 16);
            const material = new THREE.MeshBasicMaterial({ color: 0xffdd00 });
            const topStar = new THREE.Mesh(geometry, material);
            topStar.position.set(0, 24, 0);
            scene.add(topStar);
            // è¿™æ˜¯ä¸€ä¸ªå¼ºå…‰ç‚¹
            const light = new THREE.PointLight(0xffdd00, 1.5, 60);
            light.position.set(0, 24, 0);
            scene.add(light);
        }

        function loadPhotos() {
            const loader = new THREE.TextureLoader();
            let loadedCount = 0;
            
            myPhotos.forEach((url, index) => {
                loader.load(url, (texture) => {
                    // åˆ›å»ºç…§ç‰‡å¡ç‰‡
                    const aspect = texture.image.width / texture.image.height;
                    const w = 6; 
                    const h = w / aspect;
                    const geo = new THREE.PlaneGeometry(w, h);
                    const mat = new THREE.MeshBasicMaterial({ 
                        map: texture, 
                        side: THREE.DoubleSide,
                        transparent: true,
                        opacity: 0.9
                    });
                    const mesh = new THREE.Mesh(geo, mat);
                    
                    // éšæœºè½¨é“å‚æ•°
                    const orbitRadius = 25 + Math.random() * 10;
                    const orbitY = (Math.random() - 0.5) * 30;
                    const speed = 0.005 + Math.random() * 0.01;
                    const angle = (index / myPhotos.length) * Math.PI * 2;
                    
                    photoOrbits.push({ mesh, orbitRadius, orbitY, speed, angle });
                    scene.add(mesh);
                    
                    // åŠ è½½è¿›åº¦
                    loadedCount++;
                    if(loadedCount === myPhotos.length) {
                        document.getElementById('loading').style.opacity = 0;
                        setTimeout(()=> document.getElementById('loading').remove(), 1000);
                    }
                }, undefined, (err) => {
                    console.error('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å', err);
                    loadedCount++; // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­
                    if(loadedCount === myPhotos.length) document.getElementById('loading').remove();
                });
            });
        }

        function makeWish() {
            const input = document.getElementById('input-box');
            const text = input.value.trim();
            if (text === "") return;
            input.value = ""; 
            
            // ç”Ÿæˆæ–‡å­—çº¹ç†
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 512; canvas.height = 128;
            ctx.fillStyle = '#ff00de'; // éœ“è™¹ç²‰
            ctx.font = 'bold 30px "Microsoft YaHei"';
            ctx.textAlign = 'center';
            ctx.fillText(text, 256, 70);
            const texture = new THREE.CanvasTexture(canvas);

            const material = new THREE.SpriteMaterial({ map: texture, transparent: true });
            const sprite = new THREE.Sprite(material);
            sprite.scale.set(12, 3, 1);
            
            // ä»å±å¹•ä¸‹æ–¹é£å…¥
            sprite.position.set(0, -30, 20);
            
            // ç›®æ ‡ï¼šå›´ç»•æ ‘æ—‹è½¬
            sprite.userData = {
                angle: Math.random() * Math.PI * 2,
                radius: 15 + Math.random() * 5,
                y: (Math.random() - 0.5) * 20,
                speed: 0.02
            };
            
            scene.add(sprite);
            wishes.push(sprite);
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;

            // 1. æ ‘çš„è‡ªè½¬
            treeParticles.rotation.y += 0.002;
            starPoints.rotation.y -= 0.0005;

            // 2. æ¨¡æ‹Ÿå‘¼å¸å¾‹åŠ¨ (æ¨¡æ‹Ÿå¿ƒè·³/éŸ³ä¹èŠ‚å¥)
            const beat = 1 + Math.sin(time * 3) * 0.05; // ç¼©æ”¾ç³»æ•°
            treeParticles.scale.set(beat, beat, beat);
            bloomPass.strength = 1.6 + Math.sin(time * 3) * 0.2; // è¾‰å…‰å¼ºåº¦è·³åŠ¨

            // 3. è®¸æ„¿çƒåŠ¨ç”»
            wishes.forEach(sprite => {
                // èºæ—‹ä¸Šå‡å¹¶å½’ä½
                const targetX = Math.cos(sprite.userData.angle) * sprite.userData.radius;
                const targetZ = Math.sin(sprite.userData.angle) * sprite.userData.radius;
                
                // ç®€å•çš„å¹³æ»‘ç§»åŠ¨
                sprite.position.x += (targetX - sprite.position.x) * 0.05;
                sprite.position.z += (targetZ - sprite.position.z) * 0.05;
                sprite.position.y += (sprite.userData.y - sprite.position.y) * 0.05;
                
                sprite.userData.angle += sprite.userData.speed; // æŒç»­å…¬è½¬
            });

            // 4. ç…§ç‰‡å¢™åŠ¨ç”» (è®©ç…§ç‰‡å§‹ç»ˆé¢å‘ç›¸æœº)
            photoOrbits.forEach(p => {
                p.angle += p.speed;
                p.mesh.position.x = Math.cos(p.angle) * p.orbitRadius;
                p.mesh.position.z = Math.sin(p.angle) * p.orbitRadius;
                p.mesh.position.y = p.orbitY + Math.sin(time + p.angle) * 2; // ä¸Šä¸‹æµ®åŠ¨
                p.mesh.lookAt(camera.position); // æ°¸è¿œé¢å‘ç›¸æœº
            });

            composer.render();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        function getTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
            gradient.addColorStop(0, 'rgba(255,255,255,1)');
            gradient.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 32, 32);
            const texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;
            return texture;
        }

        // éŸ³ä¹æ§åˆ¶ (å¦‚æœéœ€è¦)
        let musicPlaying = false;
        const audio = new Audio('https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3?filename=christmas-ident-126633.mp3'); 
        audio.loop = true;
        document.getElementById('music-control').addEventListener('click', function() {
            if (!musicPlaying) {
                audio.play();
                this.innerText = "ğŸµ Playing...";
                musicPlaying = true;
            } else {
                audio.pause();
                this.innerText = "ğŸµ Music Off";
                musicPlaying = false;
            }
        });
    </script>
</body>
</html>
