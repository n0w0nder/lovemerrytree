<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart to Heart</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
    body { background: #f5f5f7; padding: 40px 20px; font-family: -apple-system, sans-serif; }
    .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 900px; margin: 0 auto; }
    .card { background: white; border-radius: 28px; padding: 25px; border: 0.5px solid rgba(0,0,0,0.05); position: relative; }
    .name-tag { font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase; margin-bottom: 20px; display: block; }
    
    .msg-item {
        background: #fbfbfd; padding: 15px; border-radius: 16px;
        margin-bottom: 10px; font-size: 14px; line-height: 1.5; border-left: none;
    }
    .edit-btn { background: #f5f5f7; border-radius: 10px; font-size: 11px; padding: 5px 10px; border: none; cursor: pointer; }
    .save-btn { background: #0071e3; border-radius: 15px; font-weight: 600; }
    
    @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
</style>
</head>
<body>

    <div class="container">
        <div class="card blue-card">
            <div class="edit-btn" onclick="openEditor('å®å®')">âœ ç¼–è¾‘</div>
            <div class="card-header">
                <div class="avatar-small" style="background-image: url('m1.jpg');"></div>
                <span class="name-tag">å®å®çš„å¿ƒé‡Œè¯</span>
            </div>
            <div class="msg-list" id="list-å®å®">
                <div style="padding:20px; text-align:center; opacity:0.6; font-size:13px;">æ­£åœ¨è¿æ¥äº‘ç«¯...</div>
            </div>
        </div>

        <div class="card pink-card">
            <div class="edit-btn" onclick="openEditor('å®¶å®')">âœ ç¼–è¾‘</div>
            <div class="card-header">
                <div class="avatar-small" style="background-image: url('m2.jpg');"></div>
                <span class="name-tag">å®¶å®çš„å¿ƒé‡Œè¯</span>
            </div>
            <div class="msg-list" id="list-å®¶å®">
                <div style="padding:20px; text-align:center; opacity:0.6; font-size:13px;">æ­£åœ¨è¿æ¥äº‘ç«¯...</div>
            </div>
        </div>
    </div>

    <div id="editor-modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin:0 0 5px 0; color:#333;">ç¼–è¾‘å†…å®¹</h3>
            <p style="margin:0; font-size: 12px; color: #999;">æ¯å†™å®Œä¸€å¥è¯æŒ‰å›è½¦æ¢è¡Œï¼Œä¼šè‡ªåŠ¨åˆ†æˆå°æ¡ç›®å±•ç¤ºã€‚</p>
            <textarea id="text-input" placeholder="å†™ä¸‹ä½ æƒ³è¯´çš„è¯..."></textarea>
            <div class="btn-group">
                <button class="cancel-btn" onclick="closeEditor()">å–æ¶ˆ</button>
                <button class="save-btn" onclick="saveData()">âœ¨ åŒæ­¥åˆ°äº‘ç«¯</button>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // ğŸ‘‡ è¿™é‡Œçš„é’¥åŒ™è¿˜æ˜¯å¡«ä½ ä¹‹å‰çš„é‚£ä¸€å¯¹ï¼Œä¸éœ€è¦å˜ ğŸ‘‡
    // ==========================================
    const SUPABASE_URL = 'https://nnyorzfnhikhwcyyqrcm.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_u6XDQS29-S3rhe7lvremXw__uezkiXc'; // å¡«ä½  API Key é‡Œé‚£ä¸€é•¿ä¸²
    // ==========================================

    // åˆå§‹åŒ– Supabase
    const { createClient } = supabase;
    const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentEditingAuthor = '';

    // 1. ä»äº‘ç«¯æ‹‰å–æ•°æ®
    async function fetchData() {
        // æŒ‰åˆ›å»ºæ—¶é—´æ’åº
        const { data, error } = await _supabase
            .from('talk')
            .select('*')
            .order('created_at', { ascending: true });

        if (error) {
            console.error('Error:', error);
            document.getElementById('list-å®å®').innerHTML = '<div style="color:red;padding:10px;font-size:12px">è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®</div>';
            return;
        }

        // æ¸…ç©ºç°æœ‰å†…å®¹
        document.getElementById('list-å®å®').innerHTML = '';
        document.getElementById('list-å®¶å®').innerHTML = '';

        // å¦‚æœæ²¡æœ‰æ•°æ®
        if (data.length === 0) {
            const emptyTip = '<div style="padding:30px; text-align:center; opacity:0.5; font-size:13px;">( æš‚æ—¶è¿˜æ²¡æœ‰å†…å®¹ï¼Œå¿«ç‚¹å‡»å³ä¸Šè§’ç¼–è¾‘å§ )</div>';
            document.getElementById('list-å®å®').innerHTML = emptyTip;
            document.getElementById('list-å®¶å®').innerHTML = emptyTip;
            return;
        }

        // æ¸²æŸ“æ•°æ®
        data.forEach(item => {
            const author = item.author;
            let contentArray = [];
            
            try {
                contentArray = JSON.parse(item.content);
            } catch(e) {
                contentArray = [item.content];
            }
            
            const listEl = document.getElementById(`list-${author}`);
            if (listEl) {
                if (listEl.innerHTML.includes('æš‚æ—¶è¿˜æ²¡æœ‰å†…å®¹')) listEl.innerHTML = '';
                
                contentArray.forEach((text, index) => {
                    const div = document.createElement('div');
                    div.className = 'msg-item';
                    div.innerHTML = `<span style="font-weight:bold; opacity:0.3; margin-right:8px; font-family:Helvetica;">${String(index+1).padStart(2,'0')}</span>${text}`;
                    listEl.appendChild(div);
                });
            }
        });
    }

    // 2. æ‰“å¼€ç¼–è¾‘å™¨
    async function openEditor(author) {
        currentEditingAuthor = author;
        document.getElementById('modal-title').innerText = `ç¼–è¾‘ï¼š${author}çš„å¿ƒé‡Œè¯`;
        
        const { data } = await _supabase
            .from('talk')
            .select('content')
            .eq('author', author)
            .single();

        const textarea = document.getElementById('text-input');
        if (data && data.content) {
            try {
                const arr = JSON.parse(data.content);
                textarea.value = arr.join('\n');
            } catch (e) {
                textarea.value = data.content;
            }
        } else {
            textarea.value = '';
        }

        document.getElementById('editor-modal').style.display = 'flex';
    }

    function closeEditor() {
        document.getElementById('editor-modal').style.display = 'none';
    }

    // 3. ä¿å­˜æ•°æ®
    async function saveData() {
        const rawText = document.getElementById('text-input').value;
        if (!rawText.trim()) return alert('å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦~');
        
        const contentArray = rawText.split('\n').filter(t => t.trim() !== '');
        
        const saveBtn = document.querySelector('.save-btn');
        const originalText = saveBtn.innerText;
        saveBtn.innerText = 'â³ åŒæ­¥ä¸­...';

        try {
            const { data: existing } = await _supabase
                .from('talk')
                .select('id')
                .eq('author', currentEditingAuthor)
                .single();

            const jsonContent = JSON.stringify(contentArray);
            let result;

            if (existing) {
                result = await _supabase.from('talk').update({ content: jsonContent }).eq('author', currentEditingAuthor);
            } else {
                result = await _supabase.from('talk').insert([{ author: currentEditingAuthor, content: jsonContent }]);
            }

            if (result.error) throw result.error;

            alert('åŒæ­¥æˆåŠŸï¼åˆ·æ–°çœ‹çœ‹å§~');
            closeEditor();
            fetchData();
            
        } catch (error) {
            alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
        } finally {
            saveBtn.innerText = originalText;
        }
    }

    fetchData();

</script>
</body>
</html>
